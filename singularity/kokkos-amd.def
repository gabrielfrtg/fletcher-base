Bootstrap: docker
From: rocm/dev-ubuntu-22.04:6.1.2-complete

%labels
	Maintainer "Fletcher Base Project"
	KokkosVersion "4.3.00"
	Description "Kokkos built with HIP backend for AMD GPUs"

%help
	This container provides a recent Kokkos build with HIP/ROCm support targeting
	AMD GPUs. Use `singularity run --rocm kokkos-amd.sif` to enter the
	environment with ROCm libraries exposed. Adjust the KOKKOS_VERSION and
	KOKKOS_AMD_ARCH build arguments when rebuilding if you need a different
	release or GPU architecture.
	
	Common AMD GPU architectures:
	- RX 7900 XTX: gfx1100 (RDNA 3) [default]
	- MI210: gfx90a (CDNA 2)
	- MI300X: gfx942 (CDNA 3)

%post
	set -ex

	export DEBIAN_FRONTEND=noninteractive
	apt-get update
	apt-get install -y --no-install-recommends \
		build-essential \
		ca-certificates \
		cmake \
		curl \
		gfortran \
		git \
		gnupg \
		libopenmpi-dev \
		ninja-build \
		pkg-config \
		python3 \
		python3-pip \
		python3-setuptools \
		wget \
		rocthrust-dev \
		rocprim-dev \
		locales
	
	# Generate and set locale to fix perl warnings
	locale-gen en_US.UTF-8
	update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
	
	rm -rf /var/lib/apt/lists/*

	# Build and install Kokkos from the latest tagged release.
	export KOKKOS_VERSION="${KOKKOS_VERSION:-4.3.00}"
	export KOKKOS_AMD_ARCH="${KOKKOS_AMD_ARCH:-AMD_GFX1100}"
	export KOKKOS_SOURCE_DIR="/tmp/kokkos-${KOKKOS_VERSION}"
	export KOKKOS_BUILD_DIR="${KOKKOS_SOURCE_DIR}/build"
	export KOKKOS_INSTALL_DIR="/opt/kokkos/${KOKKOS_VERSION}"

	mkdir -p "${KOKKOS_SOURCE_DIR}" "${KOKKOS_BUILD_DIR}" "${KOKKOS_INSTALL_DIR}"

	if ! git clone --branch "${KOKKOS_VERSION}" --depth 1 https://github.com/kokkos/kokkos.git "${KOKKOS_SOURCE_DIR}"; then
		rm -rf "${KOKKOS_SOURCE_DIR}"
		mkdir -p "${KOKKOS_SOURCE_DIR}"
		curl -sSL "https://github.com/kokkos/kokkos/archive/refs/tags/${KOKKOS_VERSION}.tar.gz" | \
			tar -xz --strip-components=1 -C "${KOKKOS_SOURCE_DIR}"
	fi

	cmake -S "${KOKKOS_SOURCE_DIR}" -B "${KOKKOS_BUILD_DIR}" \
		-G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_C_COMPILER=$(which gcc) \
		-DCMAKE_CXX_COMPILER=$(which hipcc) \
		-DCMAKE_CXX_STANDARD=17 \
		-DCMAKE_INSTALL_PREFIX="${KOKKOS_INSTALL_DIR}" \
		-DCMAKE_PREFIX_PATH="/opt/rocm" \
		-DKokkos_ENABLE_SERIAL=ON \
		-DKokkos_ENABLE_OPENMP=ON \
		-DKokkos_ENABLE_HIP=ON \
		-DKokkos_ENABLE_HIP_RELOCATABLE_DEVICE_CODE=OFF \
		-DKokkos_ENABLE_LIBDL=ON \
		-DKokkos_ENABLE_EXAMPLES=OFF \
		-DKokkos_ENABLE_TESTS=OFF \
		-DKokkos_ENABLE_COMPILER_WARNINGS=OFF \
		-DTPL_ENABLE_ROCTHRUST=OFF \
		-DKokkos_ARCH_${KOKKOS_AMD_ARCH}=ON

	cmake --build "${KOKKOS_BUILD_DIR}" --target install

	# Clean build artifacts to keep image slim.
	rm -rf /tmp/kokkos-

	# Provide a default modulefile-like environment hint.
	cat <<'EOF' >/etc/profile.d/kokkos.sh
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export KOKKOS_VERSION=${KOKKOS_VERSION:-4.3.00}
export KOKKOS_ROOT=/opt/kokkos/${KOKKOS_VERSION}
export PATH=${KOKKOS_ROOT}/bin:${PATH}
export LD_LIBRARY_PATH=${KOKKOS_ROOT}/lib:${KOKKOS_ROOT}/lib64:${LD_LIBRARY_PATH}
export HIP_VISIBLE_DEVICES=${HIP_VISIBLE_DEVICES:-0}
EOF

%environment
	export LANG=en_US.UTF-8
	export LC_ALL=en_US.UTF-8
	export KOKKOS_VERSION=${KOKKOS_VERSION:-4.3.00}
	export KOKKOS_ROOT=/opt/kokkos/${KOKKOS_VERSION}
	export PATH=${KOKKOS_ROOT}/bin:${PATH}
	export LD_LIBRARY_PATH=${KOKKOS_ROOT}/lib:${KOKKOS_ROOT}/lib64:${LD_LIBRARY_PATH}

%runscript
	echo "Kokkos ${KOKKOS_VERSION} environment ready for AMD GPUs."
	echo "Remember to execute with 'singularity run --rocm' to expose AMD GPUs."
	exec "$@"
